<!DOCTYPE html>
<html>
<head>
  <title>CPA Client</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <link href="css/bootstrap.min.css" rel="stylesheet">

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
  <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
  <![endif]-->
</head>
<body>
<div class="container">

  <h1>CPA Browser Flow demo</h1>


  <!-- Nav tabs -->
  <ul class="nav nav-tabs" id="tabs">
    <li class="active"><a href="#bbc1" data-toggle="tab">BBC 1</a></li>
    <!--<li><a href="#bbc2" data-toggle="tab">BBC 2</a></li>-->
  </ul>

  <!-- Tab panes -->
  <div class="tab-content">
    <div class="tab-pane active" id="bbc1"><h2>BBC TWO: On TV</h2><address>Horizon - Man on Mars</address></div>
    <div class="tab-pane" id="bbc2"></div>
  </div>

  <div class="btn btn-default" id="tag-btn"><i class='glyphicon glyphicon-tag'></i> TAG</div>

</div>



<script type="text/javascript" src="js/lib/jquery.min.js"></script>
<script type="text/javascript" src="js/lib/jquery.storageapi.min.js"></script>
<script type="text/javascript" src="js/lib/bootstrap.min.js"></script>
<script type="text/javascript" src="js/lib/ejs_0.9_alpha_1_production.js"></script>

<script type="text/javascript" src="js/lib/underscore.min.js"></script>
<script type="text/javascript" src="js/lib/machina.min.js"></script>

<script type="text/javascript" src="js/lib/logger.min.js"></script>
<script type="text/javascript" src="js/logger.js"></script>

<script type="text/javascript" src="js/config.js"></script>
<script type="text/javascript" src="js/storage.js"></script>
<script type="text/javascript" src="js/request-helper.js"></script>
<script type="text/javascript" src="js/cpa-protocol.js"></script>
<script type="text/javascript" src="js/radiotag-protocol.js"></script>
<script type="text/javascript" src="js/app-fsm.js"></script>


<script>
  var extractFragment = function(uri) {
    var fragment = uri.substring(uri.indexOf('#')+1).split('&');
    var params = {}, pair, d = decodeURIComponent, i;

    for (i = fragment.length; i > 0;) {
      pair = fragment[--i].split('=');
      params[d(pair[0])] = d(pair[1]);
    }

    return params;
  };

  $(function () {
    var data = extractFragment(window.location.hash);
    console.log(data);
    if (data.access_token) {
      alert('Here is the token: ' + data.access_token);
      // TODO:
      // 1. Store into Local storage
      // 2. Use it to tag on a service
    }
  });


  $('#tag-btn').click(function() {
    currentTab = $('#tabs > li.active');

    var ap = "http://localhost:5000";

    var params = $.param({
      response_type: 'token',
      client_id: 'abc123',
      redirect_uri: 'http://local.ebu.io:8000/client/cpa-webflow.html',
      state: 'callback'
    });

    window.location.replace(ap+"/dialog/authorize?"+params);
  });

</script>
</body>
</html>
